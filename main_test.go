package main

import (
	"testing"
)

func mockAllOnDisplay() [64 * 32]uint8 {
	disp := [64 * 32]uint8{}
	for i := range disp {
		disp[i] = 0x01
	}
	return disp
}

func TestExec(t *testing.T) {
	cases := []struct {
		desc     string
		opcode   uint16
		cpu      cpu
		expected cpu
	}{
		{
			"00E0",
			0x00E0,
			cpu{disp: mockAllOnDisplay()},
			cpu{},
		},
		{
			"00EE",
			0x00EE,
			cpu{
				pc:    0x0222,
				sp:    0x02,
				stack: [16]uint16{0x0444, 0x0333, 0x0000},
			},
			cpu{
				pc:    0x0333,
				sp:    0x01,
				stack: [16]uint16{0x0444, 0x0000},
			},
		},
		{
			"1NNN",
			0x1333,
			cpu{pc: 0x0222},
			cpu{pc: 0x0333},
		},
		{
			"2NNN",
			0x2333,
			cpu{
				pc:    0x0222,
				sp:    0x00,
				stack: [16]uint16{},
			},
			cpu{
				pc:    0x0333,
				sp:    0x01,
				stack: [16]uint16{0x0222},
			},
		},
		{
			"3XKK",
			0x32FF,
			cpu{
				pc: 0x0222,
				v:  [16]uint8{0x00, 0x00, 0xFF},
			},
			cpu{
				pc: 0x0224,
				v:  [16]uint8{0x00, 0x00, 0xFF},
			},
		},
		{
			"3XKK",
			0x32FF,
			cpu{
				pc: 0x0222,
				v:  [16]uint8{0x00, 0x00, 0xEE},
			},
			cpu{
				pc: 0x0222,
				v:  [16]uint8{0x00, 0x00, 0xEE},
			},
		},
		{
			"4XKK",
			0x42FF,
			cpu{
				pc: 0x0222,
				v:  [16]uint8{0x00, 0x00, 0xEE},
			},
			cpu{
				pc: 0x0224,
				v:  [16]uint8{0x00, 0x00, 0xEE},
			},
		},
		{
			"4XKK",
			0x42FF,
			cpu{
				pc: 0x0222,
				v:  [16]uint8{0x00, 0x00, 0xFF},
			},
			cpu{
				pc: 0x0222,
				v:  [16]uint8{0x00, 0x00, 0xFF},
			},
		},
		{
			"5XY0",
			0x5120,
			cpu{
				pc: 0x0222,
				v:  [16]uint8{0x00, 0xFF, 0xFF},
			},
			cpu{
				pc: 0x0224,
				v:  [16]uint8{0x00, 0xFF, 0xFF},
			},
		},
		{
			"5XY0",
			0x5120,
			cpu{
				pc: 0x0222,
				v:  [16]uint8{0x00, 0xEE, 0xFF},
			},
			cpu{
				pc: 0x0222,
				v:  [16]uint8{0x00, 0xEE, 0xFF},
			},
		},
		{
			"6XKK",
			0x60AB,
			cpu{v: [16]uint8{}},
			cpu{v: [16]uint8{0xAB}},
		},
		{
			"7XKK",
			0x7012,
			cpu{v: [16]uint8{0x35}},
			cpu{v: [16]uint8{0x47}},
		},
		{
			"8XY0",
			0x8120,
			cpu{v: [16]uint8{0x00, 0x35, 0x47}},
			cpu{v: [16]uint8{0x00, 0x47, 0x47}},
		},
		{
			"8XY1",
			0x8121,
			cpu{v: [16]uint8{0x00, 0x01, 0x02}},
			cpu{v: [16]uint8{0x00, 0x03, 0x02}},
		},
		{
			"8XY2",
			0x8122,
			cpu{v: [16]uint8{0x00, 0x03, 0x02}},
			cpu{v: [16]uint8{0x00, 0x02, 0x02}},
		},
		{
			"8XY3",
			0x8123,
			cpu{v: [16]uint8{0x00, 0x03, 0x02}},
			cpu{v: [16]uint8{0x00, 0x01, 0x02}},
		},
		{
			"8XY4",
			0x8014,
			cpu{
				v: [16]uint8{
					0x01, 0x02, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
			cpu{
				v: [16]uint8{
					0x03, 0x02, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
		},
		{
			"8XY4",
			0x8014,
			cpu{
				v: [16]uint8{
					0xFF, 0x02, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
			cpu{
				v: [16]uint8{
					0x01, 0x02, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x01,
				},
			},
		},
		{
			"8XY5",
			0x8015,
			cpu{
				v: [16]uint8{
					0xFF, 0x02, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
			cpu{
				v: [16]uint8{
					0xFD, 0x02, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x01,
				},
			},
		},
		{
			"8XY5",
			0x8015,
			cpu{
				v: [16]uint8{
					0x02, 0xFF, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
			cpu{
				v: [16]uint8{
					0x03, 0xFF, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
		},
		{
			"8XY6",
			0x8DE6,
			cpu{
				v: [16]uint8{
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x0F, 0x00, 0x00,
				},
			},
			cpu{
				v: [16]uint8{
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x07, 0x00, 0x01,
				},
			},
		},
		{
			"8XY7",
			0x8DE7,
			cpu{
				v: [16]uint8{
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x01, 0x0A, 0x00,
				},
			},
			cpu{
				v: [16]uint8{
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x09, 0x0A, 0x01,
				},
			},
		},
		{
			"8XY7",
			0x8DE7,
			cpu{
				v: [16]uint8{
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x0A, 0x01, 0x00,
				},
			},
			cpu{
				v: [16]uint8{
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0xF7, 0x01, 0x00,
				},
			},
		},
		{
			"8XYE",
			0x800E,
			cpu{
				v: [16]uint8{
					0x80, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
			cpu{
				v: [16]uint8{
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x01,
				},
			},
		},
		{
			"8XYE",
			0x801E,
			cpu{
				v: [16]uint8{
					0x30, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
			cpu{
				v: [16]uint8{
					0x60, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
		},
		{
			"9XY0",
			0x9010,
			cpu{
				pc: 0x222,
				v: [16]uint8{
					0x30, 0x30, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
			cpu{
				pc: 0x222,
				v: [16]uint8{
					0x30, 0x30, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
		},
		{
			"9XY0",
			0x9010,
			cpu{
				pc: 0x222,
				v: [16]uint8{
					0x30, 0x50, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
			cpu{
				pc: 0x224,
				v: [16]uint8{
					0x30, 0x50, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
		},
		{
			"ANNN",
			0xA123,
			cpu{},
			cpu{i: 0x0123},
		},
		{
			"BNNN",
			0xB123,
			cpu{
				pc: 0x0333,
				v: [16]uint8{
					0x30, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
			cpu{
				pc: 0x0363,
				v: [16]uint8{
					0x30, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
					0x00, 0x00, 0x00, 0x00,
				},
			},
		},
	}

	for _, tc := range cases {
		tc.cpu.exec(tc.opcode)
		// mem
		for i := range tc.cpu.mem {
			if tc.cpu.mem[i] != tc.expected.mem[i] {
				t.Fatalf(
					"fatal memory error for %s: expected 0x%X, got 0x%X at mem index 0x%X",
					tc.desc,
					tc.expected.mem[i],
					tc.cpu.mem[i],
					i,
				)
			}
		}
		// pc
		if tc.cpu.pc != tc.expected.pc {
			t.Fatalf(
				"fatal program counter error for %s: expected 0x%X, got 0x%X",
				tc.desc,
				tc.expected.pc,
				tc.cpu.pc,
			)
		}
		// v
		for i := range tc.cpu.v {
			if tc.cpu.v[i] != tc.expected.v[i] {
				t.Fatalf(
					"fatal register error for %s: expected 0x%X, got 0x%X at register index 0x%X",
					tc.desc,
					tc.expected.v[i],
					tc.cpu.v[i],
					i,
				)
			}
		}
		// i
		if tc.cpu.i != tc.expected.i {
			t.Fatalf(
				"fatal i-reg error for %s: expected 0x%X, got 0x%X",
				tc.desc,
				tc.expected.i,
				tc.cpu.i,
			)
		}
		// dt    uint8          // delay timer
		// st    uint8          // sound timer
		// sp
		if tc.cpu.sp != tc.expected.sp {
			t.Fatalf(
				"fatal stack pointer error for %s: expected 0x%X, got 0x%X",
				tc.desc,
				tc.expected.sp,
				tc.cpu.sp,
			)
		}
		// stack
		for i := range tc.cpu.stack {
			if tc.cpu.stack[i] != tc.expected.stack[i] {
				t.Fatalf(
					"fatal stack error for %s: expected 0x%X, got 0x%X",
					tc.desc,
					tc.expected.stack[i],
					tc.cpu.stack[i],
				)
			}
		}
		// keys  [16]uint8      // keyboard state
		// disp
		for i := range tc.cpu.disp {
			if tc.cpu.disp[i] != tc.expected.disp[i] {
				t.Fatalf(
					"fatal display error for %s: expected 0x%X, got 0x%X at disp index 0x%X",
					tc.desc,
					tc.expected.disp[i],
					tc.cpu.disp[i],
					i,
				)
			}
		}
	}
}
